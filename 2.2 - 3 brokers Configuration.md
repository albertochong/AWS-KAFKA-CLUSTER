


# 3 brokers Configuration
Cluster with 3 brokes.

### Run in terminal on each 3 instances as root 

* attach and format 2 diferents EBS disks for data logs
```bash
sudo su \

# check disks on the server
lsblk 
```
![alt text](https://achong.blob.core.windows.net/gitimages/disks.PNG)


* Check if disk is empty, if return "Data" , yes is empty
```bash
file -s /dev/xvdb \
file -s /dev/xvdc
```
![alt text](https://achong.blob.core.windows.net/gitimages/disks_empty.PNG)


* Install packages to mount as xfs
#### Note on Kafka: it's better to format volumes as xfs:
#### https://kafka.apache.org/documentation/#filesystems
```bash
apt-get install -y xfsprogs

# create a partition
fdisk /dev/xvdb
fdisk /dev/xvdc

# format as xfs
mkfs.xfs -f /dev/xvdb
mkfs.xfs -f /dev/xvdc

# create data directory
mkdir /broker
mkdir /broker/data
mkdir /broker/data1

# Give permissions to data directory
chown -R ubuntu:ubuntu /broker/data
chown -R ubuntu:ubuntu /broker/data1

# mount volume
mount -t xfs /dev/xvdb /broker/data
mount -t xfs /dev/xvdc /broker/data1

```

* Checking disks
```bash
df -h
```

![alt text](https://achong.blob.core.windows.net/gitimages/disks_partition.PNG)



* Edit the hosts file and add the following entries 
```bash
sudo nano /etc/hosts
172.31.22.104 zookeeper1
172.31.31.206 zookeeper2
172.31.22.176 zookeeper3

172.31.3.111  broker1
172.31.5.198  broker2
172.31.10.181 broker3
```

* On each server, edit the broker config file and add the lines:
```bash
sudo nano /opt/kafka/config/server.properties
```
Name/Value   | Description
------------ | -------------
**** | 
**** |                                     
**** | 
**** | 
**** |  
**** | 
**** | 
**** | 
**** | 
**** | 
**** | 
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
**** |                                     
**** | 
**** | 
**** |  
**** | 
**** | 
**** | 
**** | 
**** | 
**** | 



* Set the Zookeeper ID for each server
```bash 

``` 

* Setup zookeeper as service
```bash 
  * Create a file .service.Add the following lines to the file to define the ZooKeeper Service
    sudo nano /etc/systemd/system/zookeeper.service
    ################################################################################################
    [Unit]
    Description=Zookeeper Daemon
    Documentation=http://zookeeper.apache.org
    Requires=network.target
    After=network.target

    [Service]
    Type=simple
    WorkingDirectory=/opt/kafka/bin
    User=ubuntu
    Group=ubuntu
    ExecStart=/opt/kafka/bin/zookeeper-server-start.sh /opt/kafka/config/zookeeper.properties
    ExecStop=/opt/kafka/bin/zookeeper-server-stop.sh /opt/kafka/config/zookeeper.properties
    LimitNOFILE=100000
    TimeoutStopSec=180
    Restart=no

    [Install]
    WantedBy=multi-user.target
    ################################################################################################
    
  * Reload
    ```bash
    sudo systemctl daemon-reload
    ```
    
  * Enable Service
    ```bash
    sudo systemctl enable zookeeper.service
    ```  
    
  * start Service
    ```bash
    sudo systemctl start zookeeper.service
    ```
    
  * Check Service status
    ```bash
    sudo systemctl status zookeeper.service
    ```
    
``` 

![alt text](https://achong.blob.core.windows.net/gitimages/zookeeper_ensemble.PNG)



*  Testing zookeeper comunication between nodes.From each node typing:
```bash 
 zookeeper-shell.sh zookeeper2:2181 --------> from server 1
 zookeeper-shell.sh zookeeper3:2181 --------> from server 2
 zookeeper-shell.sh zookeeper1:2181 --------> from server 3
``` 

![alt text](https://achong.blob.core.windows.net/gitimages/zookeeper_ensemble_connection.PNG)

